# Krack8 Lighthouse

## Introduction

This chart bootstraps a Krack8 Lighthouse deployment on a Kubernetes cluster using the Helm package manager.

## Prerequisites

- Kubernetes 1.25+
- Helm 3.8.0+
- PV provisioner support in the underlying infrastructure
- ReadWriteOnce volumes for database (if database creation required)

## Installing the Chart

To adding the chart repository with the name `krack8`:

```
helm repo add krack8 https://krack8.github.io/helm-charts
```

The command pulls Krack8 charts on the Kubernetes cluster. 

> **Tip**: Verify the chart by running `helm search repo`

## Configuration and installation details

Lighthouse consists of three major components:

* **Lighthouse Controller** (`lighthouse-controller`): The core component that handles all incoming requests. Lighthouse controller runs two serves: http server and gRPC server.
* **Lighthouse Webapp** (`lighthouse-webapp`): The graphical user interface for visualizing clusters. It connects to the Lighthouse controller's http server.
* **Lighthouse Agent** (`lighthouse-agent`): This component that gets deployed inside each Kubernetes cluster to monitor its resources. Lighthouse agent connects to the Lighthouse controller's gRPC server.

To install Lighthouse, you need to set up the controller, webapp, and agents. You can install them using one of the following methods:

* **Full Installation**: Deploy all components (controller, webapp, and agents) with a single command.
* **Controller-Only Installation**: Set up only the Lighthouse controller and webapp on a single cluster.
* **Agent-Only Installation**: Deploy only the Lighthouse agent inside a Kubernetes cluster.


### Install Lighthouse controller and webapp

This chart allows you to install the Lighthouse controller and webapp by setting `controller.enabled` to `true`.

To install the chart with the release name `my-release`, use the following command:

```
helm install my-release krack8/lighthouse --create-namespace --namespace my-namepsace --set controller.enabled=true
```

> **Note:** Replace the `krack8` repository name if you have set any other name. You can also update the helm release name `my-release` and `my-namespace` if needed.

This command will first create the namespace if it does not already exist, then apply the **lighthouse controller** and **lighthouse webapp** deployments along with other necessary resources. The Lighthouse controller's http server will by default run on port `8080`, while the gRPC server will run on port `50051`. The webapp runs on port `8000`.

> **Note:** 
>> Applying the command by setting only `controller.enabled` to `true` won't give you access to the Lighthouse webapp from the browser directly. 
> To access it, you will need to add an ingress using additional parameters. Alternatively, you may use **lighthouse controller** and **lighthouse webapp** via port-forwarding.  
>
>> If ingress does not exist for gRPC, then the **lighthouse agent** will only work if it is set up on the same Kubernetes cluster where the **lighthouse controller** is deployed.

### Install Lighthouse agent

This chart allows you to install the Lighthouse agent by setting `agent.enabled` to `true`.

To install Lighthouse agent, there are some required parameters which you need to provide, in order to connect with the **lighthouse controller**
* `auth.token` - A token which will be generated by the lighthouse controller. This is You will get the token from **lighthouse webapp** while adding a new custer.
* `agent.group` - A group id which will be generated by the lighthouse controller. This is You will get the token from **lighthouse webapp** while adding a new custer.
* `controller.grpc.url` - The **lighthouse controller** grpc url for connecting the agent to controller. You will get the token from **lighthouse webapp** while adding a new custer.

> **Note**: 
>> Before installing **lighthouse agent**, you need to install **lighthouse controller** and **lighthouse webapp**. 
>
>> If you install **lighthouse agent** along with **lighthouse controller** using a single command, then the **lighthouse agent** won't
> need the required parameters, since **lighthouse controller** will set those values automatically. 
> These values are only required if you install **lighthouse agent** individually.

To install the chart with the release name `my-agent-release`, use the following command:
```
helm install my-agent-release krack8/lighthouse --create-namespace --namespace my-namepsace \
--set agent.enabled=true \
--set auth.token="xxxxxxxxxxx" \
--set controller.grpc.url="lighhouse-controller:50051" \
--set agent.group="xxxx"
```

> **Note:** 
>> Replace the `krack8` repository name if you have set any other name. You can also update the helm release name `my-agent-release` and `my-namespace` if needed.
>
>> Update the controller grpc server address, auth token and agent group. You will find these values from **lighthouse webapp** while adding a new cluster.

While initiating the gRPC connection with the **Lighthouse controller**, the **Lighthouse agent** adds a TLS connection and tries to verify the TLS certificates for the gRPC server by default.
If you are not using an ingress for grpc then you may set `agent.connectServerInternally` to `true` and to turn the tls verification off you can set  and `agent.skipServerTlsVerification` to `true`.

> **Note:** Please make sure to set `agent.connectServerInternally` to `true` and `agent.skipServerTlsVerification` to `true`, if you are not enabling ingress for controller grpc.

### Install lighthouse controller and server

You can install **lighthouse controller**, **lighthouse webapp** and **lighthouse agent** together with a single command.

e.g
```
helm install my-agent-release krack8/lighthouse --create-namespace --namespace my-namepsace --set controller.enabled=true --set agent.enabled=true
```

### Lighthouse Default User

To access the lighthouse, you will require a default user. Lighthouse controller creates a user with default
credentials. By default, a user is created using default username `admin@default.com` and with default password `admin123`. 

This chart allows you to modify the user credentials before installing the **lighthouse controller** by setting
values to `user.email` and `user.password`.

### Resource requests and limits

Krack8 charts allow setting cpu and memory resource `requests` and `limits` for all containers inside the chart deployment.

To specify resources for all deployments, the Krack8 Lighthouse chart supports the `global.resources` field. Setting this field applies resource limits and requests to all deployments in the chart. 

For more granular control, the chart also allows defining resource requests and limits for specific deployments individually. 
You can set resource values to `controller.resources`, `controller.webapp.resources` and `agent.resources` for adding controller, webapp and agent deployment resources respectively.

e.g.
```
helm install my-release krack8/lighthouse --create-namespace --namespace my-namepsace \
--set controler.enabled=true \
--set controler.resources.requests.cpu="50m" \
--set controler.resources.requests.memory="128Mi"
```

### Database

Krack8 Lighthouse chart integrate database to store metadata and other configurations. Currently, the lighthouse chart supports mongodb database integration. 
You can create a new mongo database using this chart or integrate existing mongo database.

The chart allows you to create database using `db.mongo.create`. Root user credentials can also be provided for creation by setting values to `db.rootUser.username` and `db.rootUser.password`. If not 
provided, the database will be created using default credentials. These credentials are saved as a kubernetes secret in the namespace where database will be deployed.

If you have an existing mongodb, it is also possible to add that by setting the uri to `db.mongo.uri`(format: `mongodb://<username>:<password>@<mongodb server address>:<mongo port>`).

> **Note:** If you are providing `db.mongo.uri`, then replace the placeholders in the given format according to your configuration.

If you want to create the database, this chart allows you to add db storage configuration by setting values under `db.persistence` section. You can set the following:
- `db.persistence.size`: For setting the size of the persistent volume. Default value is "1Gi". 
- `db.persistence.storageClassName`: Set your cluster's storage class name.
- `db.persistence.annotations`: You can set annotations for persistent volume. 
- `db.persistence.accessMode`: You can set accessMode for the persistent volume. Default value is "ReadWriteOnce"

### Ingress

The Krack8 lighthouse chart provides support for Ingress resources to enable external access. If an Ingress controller is installed in your cluster, such as **nginx-ingress-controller**, **HAProxy**, or any other Ingress controller, it can be utilized to route traffic. 
Ingress is used to expose both the **lighthouse controller** http and grpc server, and the **lighthouse webapp**.

To enable ingress, set `ingress.enabled` to `true` for the controller's HTTP Ingress and `ingressGrpc.enabled` to `true` for the controller's gRPC Ingress. 
If ingress is enabled, then you need add the hostnames as well. You can set hostname for http server ingress by setting `ingress.hostname` and for
grpc ingress by setting `ingressGrpc.hostname`.

> **Note:** If you set `ingress.enabled` to `true`, the chart will create an ingress that will route the traffic for both **lighthouse controller** and **lighthouse webapp** based on routes.

The chart also allows you to add additional parameters for both http server ingress and grpc ingress.
- `ingress.annotations` and `ingressGrpc.annotations`: For adding annotations depending on your ingress controller.
- `ingress.ingressClassName` and `ingressGrpc.ingressClassName`: For setting ingress class name based on your ingress controller.
- `ingress.pathType` and `ingressGrpc.pathType`: For setting ingress pathType. Default value is `ImplementationSpecific`.
- `ingress.apiVersion` and `ingressGrpc.apiVersion`: For setting ingress apiVersion depending on your cluster's supported ingress apiVersion. By default, the chart will set 
the apiVersion based on your cluster's configurations.

### Securing traffic using TLS

TLS support is also available for securing Ingress traffic. To enable TLS , set `ingress.tls.enabled` to `true` and `ingressGrpc.enabled` to `true` for http ingress and grpc ingress respectively. 
If TLS is enabled, it is mandatory to provide the certificate, certificate private key and certificate authority (if custom ca).

The chart allows you to provide a secret name consisting of certificate (`tls.crt`), certificate key (`tls.key`), and certificate authority (`ca.crt`) if necessary. You can set the secret name for ingress by setting value 
to `ingress.tls.secretName` and `ingressGrpc.tls.secretName`.

> **Note:** 
>> Make sure the secret exists in the same namespace where you want to install the **lighthouse controller**. 
>
>> If you are using **cert-manager**, you can set a secret name and add cert manager annotations to `ingress.annotations` and `ingressGrpc.annotations`. The cert manager will create the secret for you and store 
> the certificate inside the secret.

The chart also allows you to add certificates directly instead of providing secret name. 
- `ingress.tls.crt` and `ingressGrpc.tls.crt`: Your certificate for the ingress host. e.g. 
```
--set ingress.tls.crt="-----BEGIN CERTIFICATE-----
MIIFATCCA+mgAwIBAgISBK65Pjc/MdGCizcwmq40d+sNMA0GCSqGSIb3DQEBCwUA
kxXSh4JwRQB1DQ4LVQRkXq37axucKaap5a8pSjlFULMzJ+d+jcnGc7BBiueFs5v6
GXL9vAUEFuvHCyoc7I+Y18ekpPPPFBQuTdxHA2UfZMwBRYTFHQ==
-----END CERTIFICATE-----"
```
- `ingress.tls.key` and `ingressGrpc.tls.key`: Your certificate private key for the ingress host. e.g.
```
--set ingress.tls.key="-----BEGIN RSA PRIVATE KEY-----
MIIEogIBAAKCAQEAuvXBcqLD3LkqN6zTWovgJZ2WeZC21Zbnxb509n6iWSlq50G2
1i+MOtlPByL2VIKRg4fNB8IlCZrZ/b/Mq55PXiQyD9YEo2hxWYc=
-----END RSA PRIVATE KEY-----"
```
- `ingress.tls.ca` and `ingressGrpc.tls.ca`: If you have a custom authority, you can add the certificate authority for the ingress host. e.g.
```
--set ingress.tls.ca="-----BEGIN CERTIFICATE-----
MIIFATCCA+mgAwIBAgISBK65Pjc/MdGCizcwmq40d+sNMA0GCSqGSIb3DQEBCwUA
GXL9vAUEFuvHCyoc7I+Y18ekpPPPFBQuTdxHA2UfZMwBRYTFHQ==
-----END CERTIFICATE-----"
```

> **Note:** If you are using your custom certificate authority in TLS, make sure your add it to
> `ingress.tls.ca` and `ingressGrpc.tls.ca` (even if you set secretName)

## Parameters

### Global parameters

| Name                      | Description                                                                          | Value                        |
|---------------------------|--------------------------------------------------------------------------------------|------------------------------|
| `global.runMode`          | Run mode for Lighthouse services (options: `PRODUCTION`, `DEVELOP`)                  | `"PRODUCTION"`               |
| `global.image.repository` | Global Docker image repository                                                       | `quay.io/klovercloud/krack8` |
| `global.image.pullPolicy` | Global Docker image pull policy                                                      | `IfNotPresent`               |
| `global.resources`        | Global resource (limit,request) section for containers inside Lighthouse deployments | `{}`                         |
| `global.kubeVersion`      | Kubernetes version for your cluster. The chart will detect it if not provided.       | `""`                         |


