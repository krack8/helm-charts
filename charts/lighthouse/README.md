# Krack8 Lighthouse

## Introduction

This chart bootstraps a Krack8 Lighthouse deployment on a Kubernetes cluster using the Helm package manager.

## Prerequisites

- Kubernetes 1.25+
- Helm 3.8.0+
- PV provisioner support in the underlying infrastructure
- ReadWriteOnce volumes for database (if database creation required)

## Installing the Chart

To adding the chart repository with the name `krack8`:

```
helm repo add krack8 https://krack8.github.io/helm-charts
```

The command pulls Krack8 charts on the Kubernetes cluster. 

> **Tip**: Verify the chart by running `helm search repo`

## Configuration and installation details

Lighthouse consists of three major components:

* **Lighthouse Controller** (`lighthouse-controller`): The core component that handles all incoming requests. Lighthouse controller runs two serves: http server and gRPC server.
* **Lighthouse Webapp** (`lighthouse-webapp`): The graphical user interface for visualizing clusters. It connects to the Lighthouse controller's http server.
* **Lighthouse Agent** (`lighthouse-agent`): This component that gets deployed inside each Kubernetes cluster to monitor its resources. Lighthouse agent connects to the Lighthouse controller's gRPC server.

To install Lighthouse, you need to set up the controller, webapp, and agents. You can install them using one of the following methods:

* **Full Installation**: Deploy all components (controller, webapp, and agents) with a single command.
* **Controller-Only Installation**: Set up only the Lighthouse controller and webapp on a single cluster.
* **Agent-Only Installation**: Deploy only the Lighthouse agent inside a Kubernetes cluster.


### Install Lighthouse controller and webapp

This chart allows you to install the Lighthouse controller and web app by setting `controller.enabled` to `true`.

To install the chart with the release name `my-release`, use the following command:

```
helm install my-release krack8/lighthouse --create-namespace --namespace my-namepsace --set controller.enabled=true
```

> **Note:** Replace the `krack8` repository name if you have set any other name. You can also update the helm release name `my-release` and `my-namespace` if needed.

This command will first create the namespace if it does not already exist, then apply the **lighthouse controller** and **lighthouse webapp** deployments along with other necessary resources. The Lighthouse controller's http server will by default run on port `8080`, while the gRPC server will run on port `50051`. The webapp runs on port `8000`.

> **Note:** 
>> Applying the command by setting only `controller.enabled` to `true` won't give you access to the Lighthouse web app from the browser directly. 
> To access it, you will need to add an ingress using additional parameters. Alternatively, you may use **lighthouse agent** and **lighthouse webapp** via port-forwarding.  
>
>> If ingress does not exist for gRPC, then the **lighthouse agent** will only work if it is set up on the same Kubernetes cluster where the **lighthouse controller** is deployed.

### Install Lighthouse agent

This chart allows you to install the Lighthouse agent setting `agent.enabled` to `true`.

To install Lighthouse agent, there are some required parameters which you need to provide, in order to connect with the **lighthouse controller**
* `auth.token` - A token which will be generated by the lighthouse controller. This is You will get the token from **lighthouse webapp** while adding a new custer.
* `agent.group` - A group id which will be generated by the lighthouse controller. This is You will get the token from **lighthouse webapp** while adding a new custer.
* `controller.grpc.url` - The **lighthouse controller** grpc url for connecting the agent to controller. This is You will get the token from **lighthouse webapp** while adding a new custer.

> **Note**: 
>> Before installing **lighthouse agent**, you need to install **lighthouse controller**. 
>
>> If you install lighthouse agent along with **lighthouse controller** using a single command, then the **lighthouse agent** won't
> need the required parameters, since **lighthouse controller** will set those values automatically. These values 
> are only required if you install **lighthouse agent** individually.

To install the chart with the release name `my-agent-release`, use the following command:
```
helm install my-agent-release krack8/lighthouse --create-namespace --namespace my-namepsace \
--set agent.enabled=true \
--set auth.token="xxxxxxxxxxx" \
--set controller.grpc.url="lighhouse-controller:50051" \
--set agent.group="xxxx"
```

> **Note:** 
>> Replace the `krack8` repository name if you have set any other name. You can also update the helm release name `my-agent-release` and `my-namespace` if needed.
>
>> Update the controller grpc server address, auth token and agent group. You will find these values from **lighthouse webapp** while adding a new cluster.

While initiating the gRPC connection with the **Lighthouse controller**, the **Lighthouse agent** adds a TLS connection and tries to verify the TLS certificates for the gRPC server by default.  
If you are trying to connect to the **Lighthouse controller** within the cluster, set `agent.connectServerInternally` to `true`. If you don’t want to verify the TLS certificates or if you don’t have any certificates, set `agent.skipServerTlsVerification` to `true`.

### Lighthouse Default User

To access the lighthouse, you will require a default user. Lighthouse controller creates a user with default
credentials. By default, a user is created using default username `admin@default.com` and with default password `admin123`. 

This chart allows you to modify the user credentials before installing the **lighthouse controller** by setting
values to `user.email` and `user.password`.

### Resource requests and limits

Krack8 charts allow setting resource requests and limits for all containers inside the chart deployment.

To specify resources for all deployments, the Krack8 Lighthouse chart supports the `global.resources` field. Setting this field applies resource limits and requests to all deployments in the chart. 

For more granular control, the chart also allows defining resource requests and limits for specific deployments individually.

### Database

Krack8 Lighthouse chart integrate database to store metadata and other configurations. Currently, the chart Lighthouse supports mongodb database integration.

The chart allows to create database using `db.mongo.create`. Root user credentials can also be provided for creation by setting values to `db.rootUser.username` and `db.rootUser.password`. 
If you already have a mongodb setup on your cluster, it also possible to add existing mongo by adding the uri to `db.mongo.uri`(format: `mongodb://<username>:<>@<mongodb >:27017`).

Chart allows db storage configuration including using `db.persistence`

The Krack8 Lighthouse chart integrates a database to store metadata and configuration details. Currently, it supports MongoDB integration.

The chart provides an option to create a new database using `db.mongo.create`, where root user credentials can also be specified during creation.

Alternatively, an existing MongoDB instance can be used by providing `db.mongo.uri`. It also allows configuring database storage through `db.persistence`.

### Ingress

The Krack8 Lighthouse chart provides support for Ingress resources to enable external access. If an Ingress controller is installed in your cluster, such as **nginx-ingress-controller**, **HAProxy**, or any other Ingress controller, it can be utilized to route traffic. Ingress is used to expose both the Lighthouse controller and the webapp services.

To enable Ingress integration, set `ingress.enabled` to `true` for the controller's HTTP Ingress and `ingressGrpc.enabled` to `true` for the controller's gRPC Ingress.

### Securing traffic using TLS

TLS support is also available for securing Ingress traffic. To enable TLS globally for both controller , set `global.ingress.tls.enabled` to `true` or for individual configuration, specify `ingress.tls.enabled` for HTTP Ingress.  For setting TLS globally for grpc ingress, set `ingressGrpc.tls.enabled` to `true`. 

The chart allows specifying certificates by providing `crt`, `key`, and `ca` (if necessary) as part of the TLS configuration. You can set certificates for controller ingress, and the chart will create a secret. You can also provide existing secret `ingress.tls.secretName`.


## Parameters

### Global parameters

| Name                      | Description                                                                          | Value                        |
|---------------------------|--------------------------------------------------------------------------------------|------------------------------|
| `global.runMode`          | Run mode for Lighthouse services (options: `PRODUCTION`, `DEVELOP`)                  | `"PRODUCTION"`               |
| `global.image.repository` | Global Docker image repository                                                       | `quay.io/klovercloud/krack8` |
| `global.image.pullPolicy` | Global Docker image pull policy                                                      | `IfNotPresent`               |
| `global.resources`        | Global resource (limit,request) section for containers inside Lighthouse deployments | `{}`                         |




