# Krack8 Lighthouse

## Introduction

This chart bootstraps a Krack8 Lighthouse deployment on a Kubernetes cluster using the Helm package manager.

## Prerequisites

- Kubernetes 1.25+
- Helm 3.8.0+
- PV provisioner support in the underlying infrastructure
- ReadWriteOnce volumes for database (if database creation required)

## Installing the Chart

To adding the chart repository with the name `krack8`:

```
helm repo add krack8 https://krack8.github.io/helm-charts
```

The command pulls Krack8 charts on the Kubernetes cluster. 

> **Tip**: Verify the chart by running `helm search repo`

## Installation details

### Install lighthouse controller and agent

This chart allows you to install **lighthouse controller**, **lighthouse webapp** and **lighthouse agent** together with a single command 
by setting `controller.enabled` to `true` and `agent.enabled` to `true`.

> **Note:** The chart allows you to install only the **lighthouse controller** by setting `controller.enabled` to `true`. After the installation, you can add
> **lighthouse agents** from the webapp. 

To install the lighthouse chart with the release name `my-release`, use the following command:
```
helm install my-release krack8/lighthouse --create-namespace --namespace my-namepsace --version 1.0.0 \
--set controller.enabled=true \
--set agent.enabled=true
```

> **Note:** Replace the `krack8` repository name if you have set any other name. You can also update the helm release name `my-release` and `my-namespace` if needed.

This command will first create the namespace if it does not already exist, and will deploy the following resources.
- **Lighthouse Controller** kubernetes resources including deployment, service, secret.
- **Lighthouse Webapp** kubernetes resources including deployment, service.
- **Lighthouse Agent** kubernetes resources including deployment, secret.
- **Lighthouse Mongo Database** kubernetes resources including deployment, service, secret.

> **Note:** 
>> By default, The controller container http server, grpc server and webapp runs on por `8080`, `50051` and `8000` respectively. You can update
>> these by setting `controller.service.targetPort`, `controller.webapp.service.targetPort` and `controller.grpc.targetPort` for http server, grpc server and webapp respectively.
>
>> Applying the command by won't provide you the access to the Lighthouse webapp from the browser directly. You need to add ingress using additional parameters. Alternatively, you may connect the **Lighthouse Controller** and **Lighthouse Webapp** via port-forwarding.


### Install Lighthouse agent

To install the **Lighthouse Agent**, the **Lighthouse Controller** must be pre-installed in one of your clusters. 
You can navigate to the **Lighthouse Webapp**, add a new cluster, and the system will generate a Helm command, 
which can then be executed on any of your Kubernetes clusters to deploy the agent.

#### Lighthouse Agent additional parameters

To install `Lighthouse Agent`, there are some additional parameters which you need to provide:

* `auth.token` - This token will be used to connect the **Lighthouse Agent** to **Lighthouse Controller**. You will get the value while adding a new cluster from the **Lighthouse Webapp**.
* `agent.group` - A group id which will be generated by the **Lighthouse Controller**. You will get the value while adding a new cluster from the **Lighthouse Webapp**.
* `config.controller.grpc.host` - The **Lighthouse Controller** grpc server host url for connecting the **Lighthouse Agent** to **Lighthouse Controller**. You will get the token from the **Lighthouse Webapp** while adding a new custer.
* `config.controller.grpc.tls.enabled` - If TLS is enabled for the grpc server **Lighthouse Controller** the value needs to be set to `True`, `False` otherwise. Default value is `False`.
* `config.controller.grpc.tls.skipVerification` - **Lighthouse Agent** by default tries to verify the TLS certificates for the **Lighthouse Controller** gRPC server. Default value is `True`. If you want to skip the verification, set the value to `False`.
* `config.controller.grpc.tls.ca` - The custom certificate authority for **Lighthouse Controller** gRPC TLS. If you have added certificates with a custom ca for the gRPC TLS connection, you need to provide the value.

> **Note**: Before applying the generated helm command the **Lighthouse Webapp**, you can add your changes to the release name, namespace, chart version and parameters.

### Lighthouse Default User

To access the lighthouse, you will require a default user. Lighthouse controller creates a user with default
credentials. By default, a user is created using default username `admin@default.com` and with default password `admin123`. 

This chart allows you to modify the user credentials before installing the **lighthouse controller** by setting
values to `user.email` and `user.password`.

### Resource requests and limits

Krack8 charts allow setting cpu and memory resource `requests` and `limits` for all containers inside the chart deployment.

To specify resources for all deployments, the Krack8 Lighthouse chart supports the `global.resources` field. Setting this field applies resource limits and requests to all deployments in the chart. 

For more granular control, the chart also allows defining resource requests and limits for specific deployments individually. 
You can set resource values to `controller.resources`, `controller.webapp.resources` and `agent.resources` for adding controller, webapp and agent deployment resources respectively.

e.g.
```
helm install my-release krack8/lighthouse --create-namespace --namespace my-namepsace \
--set controler.enabled=true \
--set controler.resources.requests.cpu="50m" \
--set controler.resources.requests.memory="128Mi"
```

### Database

Krack8 Lighthouse requires a database for storing metadata and cluster configurations. This chart allows you to integrate database. Currently, the lighthouse chart supports mongodb database integration. 
You can create a new mongo database using this chart or integrate existing mongo database. 

Installing The **Lighthouse Controller** with new database:

While installing the controller, the database creates database by default with the following parameters:
- `db.mongo.internal.enabled` - The chart creates a mongo database by default. Default value is `true`. If you don't want the chart to create the db by default, set it `false`.
- `db.mongo.internal.auth.username` - Root username for the database. If not provided, the database will be created using the default username.
- `db.mongo.internal.auth.password` - Root password for the database. If not provided, the database will be created using the default password.
- `db.mongo.internal.auth.databaseName` - The chart sets a default database name if not provided. Default database name is `lighthouse`.
- `db.mongo.internal.targetPort` - The chart sets a default port for the database. Default port is `27017`.

> **Note:** The database credentials are saved as a kubernetes secret in the namespace where database will be deployed.

This chart also allows you to add db storage configuration by setting values under `db.mongo.internal.persistence` section. You can set the following:
- `db.mongo.internal.persistence.size`: For setting the size of the persistent volume. Default value is "1Gi".
- `db.mongo.internal.persistence.storageClassName`: Set your cluster's storage class name.
- `db.mongo.internal.persistence.annotations`: You can set annotations for persistent volume.
- `db.mongo.internal.persistence.accessMode`: You can set accessMode for the persistent volume. Default value is "ReadWriteOnce"

Installing The **Lighthouse Controller** with an existing database:

If you have an existing mongodb, it is also possible to add that by setting `db.mongo.external.enabled` to `true`. Here are the parameters:
- `db.mongo.external.enabled` - For adding the existing database, need to set the value to `true`. Default value is `false`.
- `db.mongo.external.uri` - Need to provide the uri for the existing database. The format is `mongodb://<username>:<password>@<mongodb server address>:<mongo port>` (Replace the placeholders in the given format according to your configuration)
- `db.mongo.external.databaseName` - You can provide which database to use for the Lighthouse. Default database name is `lighthouse`. 

> **Note:** Make sure to disable the mongo creation while adding the existing database by setting `db.mongo.internal.enabled` to `false`.

### Ingress

The Krack8 lighthouse chart provides support for Ingress resources to enable external access. If an Ingress controller is installed in your cluster, such as **nginx-ingress-controller**, **HAProxy**, or any other Ingress controller, it can be utilized to route traffic. 
Ingress is used to expose both the **lighthouse controller** http and grpc server, and the **lighthouse webapp**.

To enable ingress, set `ingress.enabled` to `true` for the controller's HTTP Ingress and `ingressGrpc.enabled` to `true` for the controller's gRPC Ingress. 
If ingress is enabled, then you need add the hostnames as well. You can set hostname for http server ingress by setting `ingress.hostname` and for
grpc ingress by setting `ingressGrpc.hostname`.

> **Note:** If you set `ingress.enabled` to `true`, the chart will create an ingress that will route the traffic for both **lighthouse controller** and **lighthouse webapp** based on routes.

The chart also allows you to add additional parameters for both http server ingress and grpc ingress.
- `ingress.annotations` and `ingressGrpc.annotations`: For adding annotations depending on your ingress controller.
- `ingress.ingressClassName` and `ingressGrpc.ingressClassName`: For setting ingress class name based on your ingress controller.
- `ingress.pathType` and `ingressGrpc.pathType`: For setting ingress pathType. Default value is `ImplementationSpecific`.
- `ingress.apiVersion` and `ingressGrpc.apiVersion`: For setting ingress apiVersion depending on your cluster's supported ingress apiVersion. By default, the chart will set 
the apiVersion based on your cluster's configurations.

### Securing traffic using TLS

TLS support is also available for securing Ingress traffic. To enable TLS , set `ingress.tls.enabled` to `true` and `ingressGrpc.enabled` to `true` for http ingress and grpc ingress respectively. 
If TLS is enabled, it is mandatory to provide the certificate, certificate private key and certificate authority (if custom ca).

The chart allows you to provide a secret name consisting of certificate (`tls.crt`), certificate key (`tls.key`), and certificate authority (`ca.crt`) if necessary. You can set the secret name for ingress by setting value 
to `ingress.tls.secretName` and `ingressGrpc.tls.secretName`.

> **Note:** 
>> Make sure the secret exists in the same namespace where you want to install the **lighthouse controller**. 
>
>> If you are using **cert-manager**, you can set a secret name and add cert manager annotations to `ingress.annotations` and `ingressGrpc.annotations`. The cert manager will create the secret for you and store 
> the certificate inside the secret.

The chart also allows you to add certificates directly instead of providing secret name. 
- `ingress.tls.crt` and `ingressGrpc.tls.crt`: Your certificate for the ingress host. e.g. 
```
--set ingress.tls.crt="-----BEGIN CERTIFICATE-----
MIIFATCCA+mgAwIBAgISBK65Pjc/MdGCizcwmq40d+sNMA0GCSqGSIb3DQEBCwUA
...
GXL9vAUEFuvHCyoc7I+Y18ekpPPPFBQuTdxHA2UfZMwBRYTFHQ==
-----END CERTIFICATE-----"
```
- `ingress.tls.key` and `ingressGrpc.tls.key`: Your certificate private key for the ingress host. e.g.
```
--set ingress.tls.key="-----BEGIN RSA PRIVATE KEY-----
MIIEogIBAAKCAQEAuvXBcqLD3LkqN6zTWovgJZ2WeZC21Zbnxb509n6iWSlq50G2
...
-----END RSA PRIVATE KEY-----"
```
- `ingress.tls.ca` and `ingressGrpc.tls.ca`: If you have a custom authority, you can add the certificate authority for the ingress host. e.g.
```
--set ingress.tls.ca="-----BEGIN CERTIFICATE-----
MIIFATCCA+mgAwIBAgISBK65Pjc/MdGCizcwmq40d+sNMA0GCSqGSIb3DQEBCwUA
...
-----END CERTIFICATE-----"
```

## Parameters

### Global parameters

| Name                      | Description                                                                          | Value                        |
|---------------------------|--------------------------------------------------------------------------------------|------------------------------|
| `global.runMode`          | Run mode for Lighthouse services (options: `PRODUCTION`, `DEVELOP`)                  | `"PRODUCTION"`               |
| `global.image.repository` | Global Docker image repository                                                       | `quay.io/klovercloud/krack8` |
| `global.image.pullPolicy` | Global Docker image pull policy                                                      | `IfNotPresent`               |
| `global.resources`        | Global resource (limit,request) section for containers inside Lighthouse deployments | `{}`                         |


### Common parameters

| Name                | Description                                                                       | Value           |
| ------------------- |-----------------------------------------------------------------------------------| --------------- |
| `kubeVersion`       | Override Kubernetes version                                                       | `""`            |
| `nameOverride`      | String to partially override lighthouse.fullname. Default value is the chart name | `""`            |
| `fullnameOverride`  | String to fully override lighthouse.fullname. Default value is the chart name                                    | `""`            |
| `commonLabels`      | Labels to add to all deployed objects                                             | `{}`            |
